<!DOCTYPE html>
<html lang="tr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>CGA Profesyonel Devriye</title>

<script src="https://unpkg.com/html5-qrcode"></script>

<style>
body{
  background:#0b1a27;
  color:white;
  text-align:center;
  font-family:Arial;
}
#reader{width:300px;margin:auto;}
.status{margin-top:20px;font-size:22px;font-weight:bold;}
.good{color:#00ff88;}
.bad{color:#ff4444;}
.info{color:#ffaa00;}
button{padding:10px 20px;margin-top:15px;}
</style>
</head>
<body>

<h2>QR Konum Güvenli Devriye</h2>
<div id="reader"></div>
<div id="status" class="status info">QR okutun...</div>
<button onclick="resetSystem()">Sıfırla</button>

<script type="module">

import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
import { getDatabase, ref, set, get, push } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-database.js";

const firebaseConfig = {
  apiKey: "AIzaSyAUjb4CBSZxjCTxpx8S_rGLOLDeRtDTs7U",
  authDomain: "bencga-db51b.firebaseapp.com",
  databaseURL: "https://bencga-db51b-default-rtdb.europe-west1.firebasedatabase.app",
  projectId: "bencga-db51b",
  storageBucket: "bencga-db51b.firebasestorage.app",
  messagingSenderId: "568702678520",
  appId: "1:568702678520:web:82d3c6a98216990fa3d20d",
  measurementId: "G-703BGXWTFN"
};

const app = initializeApp(firebaseConfig);
const db = getDatabase(app);

let scanLock = false;

function setStatus(text,type="info"){
  const el = document.getElementById("status");
  el.className="status "+type;
  el.innerText=text;
}

function sleep(ms){ return new Promise(r=>setTimeout(r,ms)); }

function getLocation(){
  return new Promise((resolve,reject)=>{
    navigator.geolocation.getCurrentPosition(
      pos=>{
        resolve({
          lat:pos.coords.latitude,
          lng:pos.coords.longitude,
          accuracy:pos.coords.accuracy
        });
      },
      ()=>reject(),
      {enableHighAccuracy:true}
    );
  });
}

function distance(lat1,lon1,lat2,lon2){
  const R=6371e3;
  const toRad=x=>x*Math.PI/180;
  const φ1=toRad(lat1);
  const φ2=toRad(lat2);
  const Δφ=toRad(lat2-lat1);
  const Δλ=toRad(lon2-lon1);
  const a=Math.sin(Δφ/2)**2+
  Math.cos(φ1)*Math.cos(φ2)*
  Math.sin(Δλ/2)**2;
  const c=2*Math.atan2(Math.sqrt(a),Math.sqrt(1-a));
  return R*c;
}

async function createReference(qrId){
  setStatus("Referans oluşturuluyor (5 ölçüm)...","info");
  let points=[];

  while(points.length<5){
    const loc=await getLocation();

    if(loc.accuracy>25){
      setStatus("GPS sabitleniyor...","info");
      await sleep(1000);
      continue;
    }

    points.push(loc);
    setStatus(points.length+"/5 ölçüm alındı","info");
    await sleep(800);
  }

  points.sort((a,b)=>a.accuracy-b.accuracy);
  points.pop(); // en kötü accuracy'yi at

  let lat=0,lng=0;
  points.forEach(p=>{
    lat+=p.lat;
    lng+=p.lng;
  });

  lat/=points.length;
  lng/=points.length;

  await set(ref(db,"points/"+qrId+"/reference"),{
    lat,lng,createdAt:Date.now()
  });

  setStatus("Referans Kaydedildi ✅","good");
}

async function checkQR(qrId){

  if(scanLock) return;
  scanLock=true;
  setTimeout(()=>scanLock=false,3000);

  const snapshot=await get(ref(db,"points/"+qrId+"/reference"));

  if(!snapshot.exists()){
    await createReference(qrId);
    return;
  }

  const refPoint=snapshot.val();
  const loc=await getLocation();

  if(loc.accuracy>25){
    setStatus("GPS zayıf. Açık alana geçin.","bad");
    return;
  }

  const d=distance(refPoint.lat,refPoint.lng,loc.lat,loc.lng);

  const logRef=push(ref(db,"points/"+qrId+"/logs"));
  await set(logRef,{
    lat:loc.lat,
    lng:loc.lng,
    distance:d,
    accuracy:loc.accuracy,
    time:Date.now()
  });

  if(d<=12){
    setStatus("GÜVENLİ DEVRİYE ✅","good");
  }else{
    setStatus("GÜVENSİZ DEVRİYE ❌","bad");
  }
}

function resetSystem(){
  setStatus("Sistem sıfırlandı.","info");
}

window.onScanSuccess=(text)=>{
  checkQR(text);
};

const scanner=new Html5QrcodeScanner("reader",{fps:10,qrbox:250});
scanner.render(window.onScanSuccess);

</script>
</body>
</html>
